<html>
<head>
<script>
var sun = { x: 0, y: 0, r: 0 },
    mercury = { x: 0.5, y: 0.0, r: 0.2, th: 0, w: 0.09 },
    earth = { x: 0.5, y: 0.0, r: 0.5, th: 0, w: 0.066 },
    mars = { x: 0.5, y: 0.0, r: 0.6, th: 0, w: 0.05 };
var canvas, ctx, canvas2, ctx2;
var distScaleRadio, spdScaleRadio, debugCheck;
var GRAVITY = 6.67300e-11; // m^3 kg^-1 s^-2
var DISTANCE_SCALE_A = 3.6e1;
var DISTANCE_SCALE_B = 5e-9;
var DISTANCE_SCALE = 5e-10;
var SPEED_SCALE_A = 2e-5;
var SPEED_SCALE_B = 1.1e10
var SPEED_SCALE = 1e2;
var SIZE_SCALE_A = 6e-1;
var SIZE_SCALE_B = 1e-20;
function PlanetaryBody(name, color, mass, orbitRadius){
    this.Name = name;
    this.Color = color;
    this.Mass = mass;
    this.orbitPeriod = 0;
    this.Ellipse = false;
    if(typeof orbitRadius == "undefined")
        this.orbitRadius = 0;
    else if(orbitRadius instanceof Array)
    {
        this.perihelion = orbitRadius[0];
        this.aphelion = orbitRadius[1];
        this.orbitRadius = (this.perihelion + this.aphelion) / 2;
        this.f = this.orbitRadius - this.perihelion;
        this.b = Math.sqrt(this.orbitRadius * this.perihelion);
        this.semiLatus = this.b * this.b / this.orbitRadius;
        this.eccentricity = this.f / this.orbitRadius;
        this.ellipse = true;
    }
    else
        this.orbitRadius = orbitRadius;

    this.planets = [];
}
PlanetaryBody.prototype.addPlanet = function(planet){
    planet.setParent(this);
    this.planets.push(planet);
}
PlanetaryBody.prototype.setParent = function(parent){
    this.parent = parent;
    if(this.orbitRadius > 0)
        this.orbitPeriod = Math.sqrt(4 * Math.PI * Math.PI * this.orbitRadius * this.orbitRadius * this.orbitRadius / parent.Mass / GRAVITY);
}
PlanetaryBody.prototype.draw = function(context, t, x, y){
    var body = this,
        pos = {x: 0, y: 0},
        diff = {x: 0, y: 0};
    while(body.parent){
        pos = body._calculatePos(t, 0, 0);
        //context.translate(-diff.x, -diff.y);
        diff.x = diff.x - pos.x;
        diff.y = diff.y - pos.y;

        body = body.parent;
    }
    body._draw(context, t, x+diff.x, y+diff.y);
}
PlanetaryBody.prototype._draw = function(context, t, x, y){
    var pos = this._calculatePos(t, x, y);

    if(this.orbitRadius && this.Mass > 1){
        context.strokeStyle = this.Color;
        context.lineWidth = 1;
        var dist = (distScaleRadio.checked) ?
            DISTANCE_SCALE_A * Math.log(this.orbitRadius * DISTANCE_SCALE_B) :
            DISTANCE_SCALE * this.orbitRadius;
        dist = Math.max(dist, 0);
        if(this.ellipse){
            var fx = (distScaleRadio.checked) ?
                x :
                x - DISTANCE_SCALE * this.f,
            //    fy = (distScaleRadio.checked) ?
            //    y - DISTANCE_SCALE_A * Math.log(this.f * DISTANCE_SCALE_B) :
                fy =    y,
                b = (distScaleRadio.checked) ?
            DISTANCE_SCALE_A * Math.log(this.b * DISTANCE_SCALE_B) :
            DISTANCE_SCALE * this.b;
            drawEllipse(context, fx, fy, dist * 1.85, b * 1.85);
        }
        else
        {
            context.beginPath();
            context.arc(x, y, dist, 0, Math.PI * 2, true);
            context.stroke();
        }

        if(debugCheck.checked)
            context.strokeText(this.orbitRadius.toPrecision(2), pos.x + 10, pos.y + 10);
    }


    this._drawSelf(context, pos.x, pos.y);

    this._drawChildren(context, t, pos.x, pos.y);
}
PlanetaryBody.prototype._drawSelf = function(context, x, y){
    context.lineWidth = 0.5;
    context.fillStyle = this.Color;
    context.strokeStyle = this.Color;

    var size = SIZE_SCALE_A * Math.log(this.Mass * SIZE_SCALE_B);
    size = Math.max(size, 1);

    if (size >= 2.0) {
        context.shadowOffsetX = 2;
        context.shadowOffsetY = 2;
        context.shadowBlur = 2;
        context.shadowColor = "#ddd";
    }

    context.beginPath();
    context.arc(x, y, size, 0, Math.PI * 2, true);
    context.fill();
    context.closePath();
    context.stroke();

    context.shadowOffsetX = 0;
    context.shadowOffsetY = 0;
    context.shadowBlur = 0;

    context.beginPath();
    context.arc(x, y, size, 0, Math.PI * 2, true);
    context.fill();
    context.closePath();
    context.stroke();
}
PlanetaryBody.prototype._drawChildren = function(context, t, x, y){
    for(var i = 0; i < this.planets.length; i++){
        this.planets[i]._draw(context, t, x, y);
    }
}
PlanetaryBody.prototype._calculatePos = function(t, x, y){
    if (this.orbitPeriod == 0.0) {
      return {x: x, y: y};
    } else {
        //http://answers.yahoo.com/question/index?qid=20060912181938AAvLbmv
        // Currently sun is at wrong focus!
        var M = Math.sqrt(GRAVITY * this.parent.Mass / this.orbitRadius / this.orbitRadius / this.orbitRadius) * t,
            E = M,
            e = this.ellipse ? this.eccentricity : 0;
        for(var i = 0; i < 10; i++)
        {
            E = M + e * Math.sin(E);
        }
      var angle = (spdScaleRadio.checked) ? t * SPEED_SCALE_A * Math.log( SPEED_SCALE_B / this.orbitPeriod) :
            2 * Math.atan(Math.sqrt((1+e)/(1-e))*Math.tan(E/2)) * SPEED_SCALE,
        // ellipse:
        // r = p / (1 + e cos(th) )
            radius = this.ellipse ? this.semiLatus / (1 + this.eccentricity * Math.cos(angle) ) : this.orbitRadius,
        dist = (distScaleRadio.checked) ?
            DISTANCE_SCALE_A * Math.log(radius * DISTANCE_SCALE_B) :
            DISTANCE_SCALE * radius;

      return {
        x: x + dist * Math.cos(angle),
        y: y + dist * Math.sin(angle)};
    }
}
function addAsteroidBelt(body, count) {
    // Normal dist between -1 and 1
    var random = function(sd, mean){
        var r = (Math.random() + Math.random() + Math.random())*2/3 - 1;
        if(typeof sd != "undefined" &&
            typeof mean != "undefined")
            r = sd * r + mean;
        return r;
    }
    // Asteroids are generally between 2.06 and 3.27 AUs.
    for (var i = 0; i < count; i++) {
      var radius = (2.06 + Math.random() * (3.27 - 2.06)) *
      1.49597871e11; // 1 AU

      body.addPlanet(
          new PlanetaryBody("asteroid", "#777",
              random(),
              radius)
        );
    }
}
function addKuiperBelt(body, count) {
    // Normal dist between -1 and 1
    var random = function(sd, mean){
        var d=10, r=0, i=0;
        for(;i<d;i++)
            r += Math.random();
        r = r / d * 2 - 1;
        if(typeof sd != "undefined" &&
            typeof mean != "undefined")
            r = sd * r + mean;
        return r;
    }
    // Asteroids are generally between 2.06 and 3.27 AUs.
    for (var i = 0; i < count; i++) {
      var radius1 = random(15, 40) *
      1.49597871e11,
        radius2 = random(15, 40) *
      1.49597871e11; // 1 AU

      body.addPlanet(
          new PlanetaryBody("asteroid", "#777",
              Math.random(),
              [radius1, radius2])
        );
    }
}
function drawEllipse(ctx, x, y, w, h) {
  var kappa = .5522848,
      ox = (w / 2) * kappa, // control point offset horizontal
      oy = (h / 2) * kappa, // control point offset vertical
      xe = x + w / 2,       // x-end
      ye = y + h / 2,       // y-end
      xm = x,               // x-middle
      ym = y,               // y-middle
      x = x - w / 2,
      y = y - h / 2;

  ctx.beginPath();
  ctx.moveTo(x, ym);
  ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
  ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
  ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
  ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
  ctx.closePath();
  ctx.stroke();
}
var sun = new PlanetaryBody("Sun", "rgb(255,196,0)", 1.989E30);
sun.addPlanet(new PlanetaryBody("Mercury", "rgb(128,128,128)", 328.5E21, [4.60012e10,6.98169e10]));
sun.addPlanet(new PlanetaryBody("Venus", "rgb(192,128,128)", 4.867E24, [1.07477e11,1.08939e11]));
var earth = new PlanetaryBody("Earth", "rgb(40,255,40)", 5.972E24, [1.47098290e11,1.52098232e11]),
    moon = new PlanetaryBody("Moon", "rgb(96,96,96)", 7.34767e22, 3.844e8);
earth.addPlanet(moon);
sun.addPlanet(earth);
addAsteroidBelt(sun, 500);
sun.addPlanet(new PlanetaryBody("Mars", "rgb(255,40,40)", 6.39E22, [2.06669e11,2.492093e11]));
var jupiter = new PlanetaryBody("Jupiter", "rgb(192, 192, 128)", 1.898E27, [7.405736e11,8.165208e11]);
jupiter.addPlanet(new PlanetaryBody("Io", "rgb(96,96,48)", 8.931900e22, 4.21700e8));
jupiter.addPlanet(new PlanetaryBody("Europa", "rgb(96,0,48)", 4.8e22, 6.71034e8));
jupiter.addPlanet(new PlanetaryBody("Ganymede", "rgb(96,0,48)", 1.4819e23, 1.070412e9));
jupiter.addPlanet(new PlanetaryBody("Callisto", "rgb(96,0,128)", 1.0759e23, 1.882709e9));
sun.addPlanet(jupiter);
sun.addPlanet(new PlanetaryBody("Saturn", "rgb(192, 192, 128)", 568.3E24, 1.433449370e12));
sun.addPlanet(new PlanetaryBody("Uranus", "rgb(128, 192, 192)", 86.81E24, 2.876679082e12));
sun.addPlanet(new PlanetaryBody("Neptune", "rgb(128, 128, 192)", 102.4E24, 4.503443661e12));
addKuiperBelt(sun, 500);
function run(){
    init();
    var d = new Date,
        t = d.getTime();
    startTime = t;
    loop(0);
}
function init(){
    distScaleRadio = document.getElementById('dist_log_rad');
    spdScaleRadio = document.getElementById('spd_log_rad');
    debugCheck = document.getElementById('debug_chk');
    distScaleRange = document.getElementById('dist_lin_rng');
    distScaleRange.onclick = function(event){
        DISTANCE_SCALE = Math.pow(10,event.target.value);
    };
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');
    canvas2 = document.getElementById('canvas2');
    ctx2 = canvas2.getContext('2d');
    canvas3 = document.getElementById('canvas3');
    ctx3 = canvas3.getContext('2d');
    canvas4 = document.getElementById('canvas4');
    ctx4 = canvas4.getContext('2d');
}
(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame =
          window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };

    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());
function loop(time){
    time = time + startTime;
    window.requestAnimationFrame(loop);
    physics(time);
    render(time);
    //time++;
    //if(time<1000)
        //setTimeout("loop()",166);
}
var last_time = -1;
function physics(time){
    var delta = last_time - time;
    last_time = time;

    //Sun

    //Mercury
    mercury.th = (mercury.th + (mercury.w * Math.PI * delta))%(Math.PI * 2);
    mercury.x = mercury.r * Math.cos(mercury.th);
    mercury.y = mercury.r * Math.sin(mercury.th);

    //Earth
    earth.th = (earth.th + (earth.w * Math.PI * delta))%(Math.PI * 2);
    earth.x = earth.r * Math.cos(earth.th);
    earth.y = earth.r * Math.sin(earth.th);

    //Mars
    mars.th = (mars.th + (mars.w * Math.PI * delta))%(Math.PI * 2);
    mars.x = mars.r * Math.cos(mars.th);
    mars.y = mars.r * Math.sin(mars.th);
}
function render(t){

    width1 = canvas.width;
    height1 = canvas.height;

    o1 = { x: width1 / 2, y: height1 / 2 };
    o1.map = map;

    width = 400;
    height = 400;

    o = { x: width / 2, y: height / 2 };
    o.map = map;

    /*  ------------
     *  Heliocentric
    */
    ctx.fillStyle = "rgb(255,255,255)";
    ctx.fillRect (0, 0, width1, height1);
    //sun.draw(ctx, t, o1.x, o1.y);
    //earth.draw(ctx, t, o1.x, o1.y);
    //moon.draw(ctx, t, o1.x, o1.y);
    jupiter.draw(ctx, t, o1.x, o1.y);

    /* ---------------
     * Earth-centric
     * ---------------*/
    // Fade
    ctx2.fillStyle = "rgba(255,255,255,0.1)";
    ctx2.fillRect (0, 0, width, height);
    // Earth
    ctx2.fillStyle = "rgb(40,255,40)";
    ctx2.beginPath();
    ctx2.arc(o.x, o.y, 2, 0, Math.PI * 2, true);
    ctx2.fill();
    // Sun
    d = mag(earth,sun);
    a = dir(earth,sun);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx2.fillStyle = "rgb(255,196,0)";
    ctx2.beginPath();
    ctx2.arc(x, y, 5, 0, Math.PI * 2, true);
    ctx2.fill();
    // Mercury
    d = mag(earth,mercury);
    a = dir(earth,mercury);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx2.fillStyle = "rgb(128,128,40)";
    ctx2.beginPath();
    ctx2.arc(x, y, 2, 0, Math.PI * 2, true);
    ctx2.fill();
    // Mars
    d = mag(earth,mars);
    a = dir(earth,mars);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx2.fillStyle = "rgb(255,40,40)";
    ctx2.beginPath();
    ctx2.arc(x, y, 2, 0, Math.PI * 2, true);
    ctx2.fill();

    /* ---------------
     * Mars-centric
     * ---------------*/
    // Fade
    ctx3.fillStyle = "rgba(255,255,255,0.1)";
    ctx3.fillRect (0, 0, width, height);
    // Mars
    ctx3.fillStyle = "rgb(255,40,40)";
    ctx3.beginPath();
    ctx3.arc(o.x, o.y, 2, 0, Math.PI * 2, true);
    ctx3.fill();
    // Sun
    d = mag(mars,sun);
    a = dir(mars,sun);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx3.fillStyle = "rgb(255,196,0)";
    ctx3.beginPath();
    ctx3.arc(x, y, 5, 0, Math.PI * 2, true);
    ctx3.fill();
    // Earth
    d = mag(mars,earth);
    a = dir(mars,earth);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx3.fillStyle = "rgb(40,255,40)";
    ctx3.beginPath();
    ctx3.arc(x, y, 2, 0, Math.PI * 2, true);
    ctx3.fill();
    // Mercury
    d = mag(mars,mercury);
    a = dir(mars,mercury);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx3.fillStyle = "rgb(128,128,40)";
    ctx3.beginPath();
    ctx3.arc(x, y, 2, 0, Math.PI * 2, true);
    ctx3.fill();

    /* ---------------
     * Mercury-centric
     * ---------------*/
    // Fade
    ctx4.fillStyle = "rgba(255,255,255,0.1)";
    ctx4.fillRect (0, 0, width, height);
    // Mercury
    ctx4.fillStyle = "rgb(128,128,40)";
    ctx4.beginPath();
    ctx4.arc(o.x, o.y, 2, 0, Math.PI * 2, true);
    ctx4.fill();
    // Sun
    d = mag(mercury,sun);
    a = dir(mercury,sun);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx4.fillStyle = "rgb(255,196,0)";
    ctx4.beginPath();
    ctx4.arc(x, y, 5, 0, Math.PI * 2, true);
    ctx4.fill();
    // Earth
    d = mag(mercury,earth);
    a = dir(mercury,earth);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx4.fillStyle = "rgb(40,255,40)";
    ctx4.beginPath();
    ctx4.arc(x, y, 2, 0, Math.PI * 2, true);
    ctx4.fill();
    // Mars
    d = mag(mercury,mars);
    a = dir(mercury,mars);
    x = d * Math.cos(a);
    y = d * Math.sin(a);
    x = o.x+(x*o.x);
    y = o.y-(y*o.y);
    ctx4.fillStyle = "rgb(255,40,40)";
    ctx4.beginPath();
    ctx4.arc(x, y, 2, 0, Math.PI * 2, true);
    ctx4.fill();
}
function map(i){return{x:this.x+(i.x*this.x),y:this.y-(i.y*this.y)};}
function mag(a,b){return Math.sqrt((a.x - b.x)*(a.x - b.x) + (a.y - b.y)*(a.y - b.y));}
function dir(a,b){return Math.atan2((a.x - b.x),(a.y - b.y));}
</script>
</head>
<body onload="run()">
Distance:
<input type="radio" id="dist_log_rad" name="dist_scale" value="log">
<label for="dist_log_rad">Logaritmic</label>
<input type="radio" id="dist_lin_rad" name="dist_scale" value="lin" checked>
<label for="dist_lin_rad">Linear</label>
<input type="range" id="dist_lin_rng" value="-9.3" min="-11" max="-6" step="0.01" style="width:800px"><br>
Speed:
<input type="radio" id="spd_log_rad" name="spd_scale" value="log">
<label for="spd_log_rad">Logaritmic</label>
<input type="radio" id="spd_lin_rad" name="spd_scale" value="lin" checked>
<label for="spd_lin_rad">Linear</label><br>
Debug:
<input type="checkbox" id="debug_chk" name="debug">
<label for="debug_chk">Debug</label>
<button onclick="canvas.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);">Fullscreen</button>
<canvas id="canvas" width="1366" height="781"></canvas>
<canvas id="canvas2" width="400" height="400" style="border: 1px solid black;"></canvas>
<canvas id="canvas3" width="400" height="400" style="border: 1px solid black;"></canvas>
<canvas id="canvas4" width="400" height="400" style="border: 1px solid black;"></canvas>
</body>
</html>
