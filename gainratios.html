<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Bike Gain Ratios</title>
<link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap.min.css">
<style>
h3 {
  margin-bottom: 0
}
#addbike_modal a {
  font-size: .8em;
}
#addbike_modal input[type=text] {
  display: none;
}
#addbike_modal #name_txt {
  display: inline;
}
#builtin {
  display: inline-block;
  padding: 10px;
  vertical-align: top;
  width: 250px;
}
#builtin input[type=radio],
#specify input[type=radio] {
  vertical-align: baseline;
}
#builtin label,
#specify label {
  display: inline-block;
  width: 215px;
}
#specify {
  display: inline-block;
  padding: 10px;
  vertical-align: top;
}
#tooltips {
  left: 42px;
  position: absolute;
  top: 60px;
}
#tooltips p {
  cursor: pointer;
  height: 10px;
  position: absolute;
  width: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>Gain Ratios</h1>
  <canvas width="800" height="0"></canvas><br>
  <a href="#addbike_modal" role="button" class="btn" data-toggle="modal">Add Bike</a>
  <div id="tooltips"></div>
</div>

<div id="addbike_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="addbike_modal_lbl" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="addbike_modal_lbl">Choose Bike Options</h3>
  </div>
  <div class="modal-body">
    <div id="builtin">
      <input type="radio" name="specified" id="builtin_rad" checked />
      <label for="builtin_rad">
        <h4>Pick built-in bike:</h4>
      </label>
      <select id="builtin_lst"></select>
    </div>
    <div id="specify">
      <input type="radio" name="specified" id="specified_rad" />
      <label for="specified_rad">
        <h4>Or specify bike:</h4>
      </label><br>
      <label for="name_txt">Name</label>
      <input type="text" id="name_txt" required /><br>
      <label for="chainset_lst">Chainset</label>
      <select id="chainset_lst">
        <option>48 38 28</option>
        <option selected>50 34</option>
        <option>50 39 30</option>
        <option>52 39</option>
        <option>52 42</option>
      </select>
      <input id="chainset_txt" type="text"/>
      <a href="#customChainset">custom</a><br>
      <label for="sprocket_lst">Sprockets</label>
      <select id="sprocket_lst">
        <option>11 13 15 17 19 21 23 25</option>
        <option>12 13 15 17 19 21 23 26</option>
        <option>13 15 17 19 22 25 28</option>
      </select>
      <input id="sprocket_txt" type="text" />
      <a href="#customSprocket">custom</a><br>
      <label for="wheelsize_lst">Wheel Size</label>
      <select id="wheelsize_lst">
        <option value="690">27" × 1 3/8" (690 mm)</option>
        <option value="686">27" × 1 1/4" (686 mm)</option>
        <option value="684">27" × 1 1/8" (684 mm)</option>
        <option value="680">27" × 1" (680 mm)</option>
        <option value="740">700 × 56 (740 mm)</option>
        <option value="730">700 × 50 (730 mm)</option>
        <option value="708">700 × 44 (708 mm)</option>
        <option value="694">700 × 38 (694 mm)</option>
        <option value="690">700 × 35 (690 mm)</option>
        <option value="684">700 × 32 (684 mm)</option>
        <option value="672">700 × 28 (672 mm)</option>
        <option value="670">700 × 25 (670 mm)</option>
        <option value="664">700 × 20 (664 mm)</option>
        <option value="624" selected>26" × 1.50 (624 mm)</option>
        <option value="622">26" × 1.25 (622 mm)</option>
        <option value="610">26" × 1.0 (610 mm)</option>
        <option value="622">26" × 1 (650C) (622 mm)</option>
      </select>
      <input id="wheelsize_txt" type="text" />
      <a href="#customWheelsize">custom</a><br>
      <label for="cranksize_lst">Crank Size</label>
      <select id="cranksize_lst">
        <option value="170">170 mm</option>
        <option value="172.5">172.5 mm</option>
        <option value="175">175 mm</option>
        <option value="177.5">177.5 mm</option>
        <option value="180">180 mm</option>
        <option value="182.5">182.5 mm</option>
      </select>
      <input id="cranksize_txt" type="text" />
      <a href="#customCranksize">custom</a>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    <button class="btn btn-primary" id="addbike_btn">Add Bike</button>
  </div>
</div>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="http://blueimp.github.com/cdn/js/bootstrap.js"></script>
<script>
(function(){
  $(function(){
    var props = ['Chainset','Sprocket','Wheelsize','Cranksize'],
        builtin_bikes = {
        // 'bikeid': [ [chainset], [sprockets], wheelradius, cranklength, name, (primary colour), (secondary colour) ]
          //'test': [ [53], [19], 340, 170, "Test" ],
          'tdf': [ [52,39], [12,13,15,17,19,21,23,26], 336, 170, "Carrera Tdf", "rgb(255,255,0)", "rgb(0,0,0)" ],
          'triban3': [ [50,39,30], [12,13,15,17,19,21,23,25], 336, 170, "B'twin Triban 3", "rgb(255,0,0)", "rgb(96,0,0)" ],
          'I1': [ [38], [16], 311, 170, "I1", "rgb(192,192,255)", "rgb(192,192,192)" ],
          'I2': [ [52,42], [12,13,15,17,19,21,23,26], 336, 170, "I2", "rgb(255,255,0)", "rgb(0,0,0)" ],
          'supersix': [ [53,39], [11,12,13,14,15,16,17,19,21,23,25], 336, 170, "Cannondale Supersix Evo", "rgb(128,128,128)", "rgb(0,0,0)" ],
          'nukeproof': [ [36], [11,12,13,14,15,17,19,21,23,26], 330, 170, "Nukeproof Snap Comp", "rgb(202,202,202)", "rgb(40,40,40)" ]
        },
        i = 0,
        l = props.length,
        builtin_rad = $('#builtin_rad'),
        specify_rad = $('#specified_rad'),
        builtin_lst = $('#builtin_lst'),
        tooltips = $('#tooltips'),
        bikes = [],
        canvas = $('canvas')[0],
        ctx = canvas.getContext('2d');
    for(;i<l;i++){
      (function(){
        var name = props[i].toLowerCase(),
            lst = $('#'+name+'_lst'),
            txt = $('#'+name+'_txt');
        $('a[href=#custom'+props[i]+']').click(function(){
          $(this).hide();
          lst.hide();
          txt.val(lst.val());
          txt.show();
          selectSpecify();
        });
      })();
    }
    // Build Built in list
    for(b in builtin_bikes){
      $('<option>').attr("value",b).text(builtin_bikes[b][4]).appendTo(builtin_lst);
    }
    function selectBuiltin(){
      builtin_rad.attr("checked", "checked");
      specify_rad.removeAttr("checked");
    }
    function selectSpecify(){
      builtin_rad.removeAttr("checked");
      specify_rad.attr("checked", "checked");
    }
    function drawGainRatios(){
      var i,
          l = bikes.length,
          ratios,
          j,
          k,
          m,
          n,
          max = 0,
          xscale,
          last_line,
          x, y;
      canvas.height = l * 50 + 50;
      tooltips.empty();
      for(i=0;i<l;i++){
        ratios = calculateGainRatios(bikes[i]);
        m = ratios.length;
        for(j=0;j<m;j++){
          max = Math.max(max, ratios[j][0]);
        }
      }
      xscale = (canvas.width - 20) / max;
      last_line = Math.floor(max);
      ctx.strokeStyle = "rgb(192,192,192)";
      ctx.fillStyle = "rgb(192,192,192)";
      ctx.font = "12px sans-serif";
      for(i=1;i<=last_line;i++){
        ctx.beginPath();
        ctx.moveTo(i*xscale, 0);
        ctx.lineTo(i*xscale, canvas.height);
        ctx.stroke();
        ctx.fillText(i,i*xscale,12);
        ctx.fillText(i,i*xscale,canvas.height);
      }
      ctx.font = "16px sans-serif";
      for(i=0;i<l;i++){
        ratios = calculateGainRatios(bikes[i]);
        m = ratios.length;
        y = 50 + i*50;
        ctx.strokeStyle = "rgb(255,255,255)";
        ctx.fillStyle = "rgb(0,0,0)";
        ctx.lineWidth = 4;
        ctx.strokeText(bikes[i][4], 30, y);
        ctx.fillText(bikes[i][4], 30, y);
        if(bikes[i][5])
          ctx.fillStyle = bikes[i][5];
        for(j=0;j<m;j++){
          n = ratios[j].length;
          for(k=0;k<n;k++){
            x = ratios[j][k]*xscale;
            y = 50 + i*50 + (m-j-1)*10;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2, true);
            ctx.fill();
            if(bikes[i][6]){
              ctx.lineWidth = 2;
              ctx.strokeStyle = bikes[i][6];
              ctx.stroke();
            }
            $('<p>').attr("title", bikes[i][0][j]+"x"+bikes[i][1][k]).css({left:(x-5)+"px",top:(y-5)+"px"}).tooltip().appendTo(tooltips);
          }
        }
      }
    }
    function calculateGainRatios(bike){
      var out = [],
          o,
          i = 0,
          j = 0,
          l = bike[0].length,
          m = bike[1].length,
          cl = bike[3],
          wr = bike[2],
          cr,
          sp;
      for(;i<l;i++){
        o = []
        for(j=0;j<m;j++){
          cr = bike[0][i];
          sp = bike[1][j];
          o.push((wr / cl) * (cr / sp));
        }
        out.push(o);
      }
      return out;
    }
    builtin_lst.click(selectBuiltin).change(selectBuiltin);
    $('#specify input, #specify select').click(selectSpecify).change(selectSpecify);
    $('#addbike_btn').click(function(){
      $('#addbike_modal').modal('hide');
      if(builtin_rad[0].checked){
        bikes.push(builtin_bikes[builtin_lst.val()]);
        drawGainRatios();
      }else{
        var bike = [],
            chainset = $('#chainset_txt').val(),
            sprockets = $('#sprocket_txt').val(),
            wheelsize = $('#wheelsize_txt').val(),
            cranksize = $('#cranksize_txt').val(),
            name = $('#name_txt').val();
        if(!chainset)
          chainset = $('#chainset_lst').val();
        if(!sprockets)
          sprockets = $('#sprocket_lst').val();
        if(!wheelsize)
          wheelsize = $('#wheelsize_lst').val();
        if(!cranksize)
          cranksize = $('#cranksize_lst').val();
        if(!name)
          name = "bike"+(Math.random()*10000).toFixed();
        chainset = chainset.split(" ");
        sprockets = sprockets.split(" ");
        wheelsize = wheelsize / 2;
        bike.push(chainset);
        bike.push(sprockets);
        bike.push(wheelsize);
        bike.push(cranksize);
        bike.push(name);
        bikes.push(bike)
        drawGainRatios();
      }
    });
  });
})();
</script>
</body>
</html>
